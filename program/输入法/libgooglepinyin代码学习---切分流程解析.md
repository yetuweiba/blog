#libgooglepinyin代码学习---切分流程解析

目前从事了输入法相关的工作，由于是刚接触，很多相关的知识不了解，在工作初期，学习了一下[libgooglepinyin](https://code.google.com/p/libgooglepinyin),大致了解了输入发相关的知识。这篇文章是代码学习的总结，写下来以加深印象，同时更加熟悉输入法相关。顾名思义，这篇文章主要对libgooglepinyin的切分流程进行解析。文章以回答几个问题的形式来讲解切分流程。这篇文章的先决条件是阅读过libgooglepinyin的源代码或者配合文章阅读源代码。

####1.文中的切分指的是什么？
在输入法中，切分一般指将输入的拼音字符串做分割，将其分割为可能的候选组合，例如：输入的拼音字符串为"xianshi",通过切分算法，可以将其分割为*xian'shi*和*xi'an'shi*两种候选组合。

####2.libgooglepinyin中的切分算法是什么流程呢？
这个问题是这篇文章的主题，以下就开始描述其切分流程。

在讲解处理流程之前，先要讲解一些背景知识。

#####a.背景知识

**输入法处理流程**

输入法所做的事情可以概括为：根据输入的字符串，将字符串进行切分，之后拿切分的结果去字典，词典中查询，将查询的结果返回。

一般是系统的输入法框架将用户输入的字符传给输入法，输入法处理后，将候选传给框架，到此，输入法即完成了任务。

**候选的组成**

平常在使用输入法的时候，大家会注意到，每输入一个字符，输入法就需要做一次处理，进行切分，之后返回对应的输入结果，如果大家观察候选结果，会发现结果一般是按照这样的顺序来排列的：

>1.全拼，即输入的字符恰好是对应一个候选，例如，输入为"tiandaochouqin",对应"天道酬勤"<br>
>
>2.若没有全拼的结果，此时就需要智能组句了，智能组句一般指将输入字符切割后，每一段字符对应一个候选，将这些候选组合为最合适的句子，例如：输入为"jintianshigehaotianqi"，这在全拼中没有结果，切分后，可以切分为"jiantian", "shige", "haotianqi",通过相关的概率计算，可以将其组成“今天是个好天气”。<br>

>3.部分词，部分词一般指输入字符中部分字符组成的词语。在候选中，要求部分词对应的字符是由开头开始的，例如：输入字符串为"jintianshigehao","jintian"是部分词的候选，而"shige"则不是，因为它由字符开头开始的。<br>

>4.字，一般是输入字符串由开头计算，可以组成的第一个字，例如：输入字符串为"jintianshige"，那么字的候选对应的字符是"jin"。

#####b.流程分析
libgooglepinyin的切分方法是渐进式的，每次处理都会利用到先前输入的结果。在接收到输入字符串后，是由字符末尾开始处理。

它在字符串由末尾开始，向前回溯N个字符，N由最大的拼音数+1开始，到1结束(对应matrixsearcher.cpp的981行的循环)。每次循环的时候获取一个字符串，判断此字符串是否是一个**合法的拼音**(判断流程在下面专门描述)。如果是合法的拼音，则和先前输入所产生的节点进行组合，去词库中查询是否可以组成词语，如果组成词语，则将此次切分出来的字符串所指向与先前的字符串。

以上是切分算法的简单描述，下面来举例说明，我们选取一个典型的例子----mingan，这个字符串应当切分出来"ming'an"和"min'gan"两种方案。

在这之前需要先说明其中关键的数据结构：**DictMatchInfo和MatrixNode**

DictMatchInfo是音节切分的元素。MatrixNode是音节切分元素的索引，每输入一个字符(在此不先不考虑无效的i，u，v)，都会产生一些DictMatchInfo和一个MatrixNode，MatrixNode来标明此次产生DictMatchInfo在链表中的开始和结尾。在文中，以DMI作为DictMatchInfo的简称。

下面来根据"mingan"来说明libgooglepinyin的切分处理流程：

注：添加DMI节点的过程也会在下文中单独描述。

1.输入'm'<br>
向前回溯，发现只有'm'一个字符，而m是一个声母，是合法的拼音，所以在DMI链表中为其添加一个DMI的节点，同时重置将MatrixNode链表中m的元素的DMI索引，DMI的数量加1.<br>
2.输入'i'<br>
向前回溯，mi是一个合法拼音。所以为"mi"添加一个DMI节点，同时将对应的MatrixNode的DMI数目加1，DMI索引重置。而'i'不是一个合法的拼音，所以不为其添加DMI节点。<br>
3.输入'n'<br>
向前回溯，min是一个合法拼音，有声母，韵母。所以为"min"添加一个DMI节点，同时将对应的MatrixNode的DMI数目加1，DMI索引重置。而'i'和'in'不是一个合法的拼音，所以不为其添加DMI节点。<br>
4.输入'g'<br>
向前回溯，ming是一个合法拼音。所以为"ming"添加一个DMI节点，同时将对应的MatrixNode的DMI数目加1，DMI索引重置。而'i'和'in'不是一个合法的拼音，所以不为其添加DMI节点;而'g'是一个合法的拼音，因为他是一个声母简拼，但是输入n时的MatrixNode的is_full_id为false，所以此时g也不会被切割出来。<br>
5.输入'a'<br>
由上可知,minga,inga,nga都不是合法的拼音，所以忽略，ga是合法的拼音，回溯到n，将min'ga去词库中查询，可以查到词语，将这个'ga'的DMI节点的fr指向min这个节点。遍历先前的DMI节点的时候，会多遍历一次，为了将这个合法拼音作为一个单独节点，这是为了这种情况，例如，假设有三个DMI节点，分别是"ni","hao","ren",可以ni'hao是一个词语，hao的fr可以指向ni，但是"ni'hao'ren"不是词语，此时不能将'ren'的fr指向'hao',需要有一个单独的节点'hao'来让'ren'的fr指向之。<br>
6.输入'n'<br>
由上可知，mingan,ingan,ngan都不是合法的拼音，可以略过，gan是一个合法的拼音,同时"min'gan"可以在词库中查询到候选，所以'gan'的fr指向'min',同时也添加单独的'gan'节点
;'an'也是合法的拼音(元韵母)，"ming'an"也是合法词语，所以添加一个'an'节点，将'an'节点的fr指向'ming'节点,再添加一个'an'节点。'n'是合法的简拼，所以也为n添加一个DMI节点

